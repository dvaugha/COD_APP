<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Content-Security-Policy"
        content="default-src * 'unsafe-inline' 'unsafe-eval'; script-src * 'unsafe-inline' 'unsafe-eval';">
    <title>COD Golf v231</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --c1: #10B981;
            --c1d: #059669;
            --bg: #0F172A;
            --card: #1E293B;
            --mut: #94A3B8;
            --acc: #F59E0B;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            background: var(--bg);
            color: #F8FAFC;
            font-family: 'Outfit', sans-serif;
            overflow: hidden;
            height: 100vh;
        }

        .g-view {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            padding: 20px;
            background: var(--bg);
            z-index: 10;
            display: none;
            flex-direction: column;
            padding-bottom: 100px;
            -webkit-overflow-scrolling: touch;
        }

        .g-view.active {
            display: flex;
            z-index: 100;
        }

        .box {
            background: var(--card);
            padding: 16px;
            border-radius: 16px;
            margin-bottom: 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        .flex-r {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .g-btn {
            background: var(--c1);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 900;
            font-size: 16px;
            padding: 16px;
            text-transform: uppercase;
            width: 100%;
            cursor: pointer;
        }

        .g-btn-sm {
            padding: 8px 16px;
            font-size: 11px;
            width: auto;
            border-radius: 8px;
        }

        .g-btn-sec {
            background: #334155;
            border: 1px solid #475569;
        }

        .g-inp {
            background: #0F172A;
            border: 1px solid #334155;
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 16px;
            width: 100%;
            display: block;
        }

        .tx-xl {
            font-size: 24px;
            font-weight: 900;
            letter-spacing: -0.5px;
        }

        .tx-sm {
            font-size: 12px;
            font-weight: 700;
            color: var(--mut);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 4px;
        }

        .chip {
            display: inline-flex;
            background: #1E293B;
            border: 1px solid #334155;
            border-radius: 12px;
            margin: 4px;
            overflow: hidden;
            transition: 0.2s;
            -webkit-transform: translate3d(0, 0, 0);
        }

        .chip-lbl {
            padding: 12px 16px;
            font-size: 15px;
            font-weight: 700;
            color: white;
            pointer-events: none;
        }

        .del-mode .chip {
            background: #EF4444;
            border-color: #fff;
            cursor: pointer;
        }

        .del-mode .chip-lbl {
            color: white;
            text-decoration: line-through;
            font-weight: 900;
        }

        .role-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            background: #0F172A;
            border-radius: 12px;
            padding: 8px 12px;
            border: 1px solid #334155;
        }

        .role-lbl {
            width: 80px;
            font-size: 10px;
            font-weight: 900;
            line-height: 1.2;
            text-transform: uppercase;
        }

        .role-sel {
            flex: 1;
            background: transparent;
            border: none;
            color: white;
            font-size: 16px;
            font-weight: 700;
            outline: none;
        }

        .top-bar {
            position: sticky;
            top: 0;
            z-index: 50;
            background: var(--card);
            margin: -20px -20px 20px -20px;
            padding: 16px;
            padding-top: max(20px, env(safe-area-inset-top));
            border-bottom: 4px solid var(--c1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .nav-btn {
            width: 52px;
            height: 52px;
            background: #334155;
            border-radius: 12px;
            color: white;
            font-size: 24px;
            font-weight: 900;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .h-stat {
            text-align: center;
            min-width: 50px;
        }

        .h-stat-lbl {
            font-size: 10px;
            text-transform: uppercase;
            font-weight: 900;
            color: var(--mut);
        }

        .h-stat-val {
            font-size: 15px;
            font-weight: 900;
            color: white;
        }

        .match-stat {
            font-size: 14px;
            font-weight: 900;
            color: white;
            text-align: right;
            text-transform: uppercase;
        }

        .match-stat em {
            color: #10B981;
            font-style: normal;
        }

        .p-card {
            background: #0F172A;
            border-radius: 24px;
            border: 1px solid #334155;
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            position: relative;
        }

        .p-card.has-score {
            border-color: var(--c1);
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.15);
        }

        .btn-act {
            width: 64px;
            height: 64px;
            border-radius: 18px;
            font-size: 28px;
            font-weight: 900;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .btn-minus {
            background: #1E293B;
            border: 1px solid #334155;
            color: #F87171;
        }

        .btn-minus:active {
            background: #334155;
        }

        .btn-plus {
            background: var(--c1);
            border-bottom: 4px solid var(--c1d);
            color: white;
            box-shadow: 0 4px 6px rgba(16, 185, 129, 0.4);
        }

        .btn-plus:active {
            border-bottom: 0;
            transform: translateY(4px);
            box-shadow: none;
        }

        .ctr-area {
            flex: 1;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 64px;
        }

        .p-name {
            font-size: 12px;
            font-weight: 900;
            letter-spacing: 1px;
            color: var(--mut);
            text-transform: uppercase;
        }

        .p-ghost {
            font-size: 10px;
            color: #475569;
            font-weight: 700;
            margin-top: 2px;
        }

        .p-score {
            font-size: 42px;
            font-weight: 900;
            color: white;
            line-height: 1;
            display: none;
        }

        .p-card.has-score .p-score {
            display: block;
        }

        .p-card.has-score .p-ghost {
            display: none;
        }

        /* CARD SPECIFIC CSS */
        .card-con {
            margin: -20px;
            padding: 20px;
            padding-bottom: 40px;
        }

        .card-table-wrap {
            overflow-x: auto;
            margin-bottom: 20px;
            border-bottom: 1px solid #334155;
            -webkit-overflow-scrolling: touch;
            display: block;
        }

        table {
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
            margin-bottom: 0;
            table-layout: fixed;
            min-width: 320px;
        }

        th,
        td {
            border: 1px solid #334155;
            padding: 4px 2px;
            text-align: center;
            font-size: 10px;
            font-weight: 700;
            white-space: nowrap;
            height: 34px;
            box-sizing: border-box;
        }

        th {
            background: #0F172A;
            color: var(--mut);
            border-top: none;
            height: 24px;
            font-size: 9px;
            vertical-align: middle;
        }

        td {
            background: #1E293B;
            color: white;
            vertical-align: middle;
        }

        th:first-child,
        td:first-child {
            position: sticky;
            left: 0;
            z-index: 2;
            border-right: 2px solid #334155;
            width: 45px;
            min-width: 45px;
            max-width: 45px;
            text-align: center;
            padding: 0;
            background: #0F172A;
        }

        td:first-child {
            background: #1E293B;
            color: var(--c1);
            font-weight: 900;
        }

        .sc-val {
            display: flex;
            width: 22px;
            height: 22px;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            margin: 0 auto;
            font-size: 10px;
        }

        .sc-bird {
            border-radius: 50%;
            border: 1px solid #10B981;
            color: #10B981;
        }

        .sc-eagle {
            border-radius: 50%;
            border: 3px double #10B981;
            color: #10B981;
        }

        .sc-bog {
            border: 1px solid #F87171;
            color: #F87171;
        }

        .sc-dbl {
            border: 3px double #F87171;
            color: #F87171;
        }

        #auto-adv-banner {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(16, 185, 129, 0.95);
            color: white;
            padding: 16px;
            text-align: center;
            font-weight: 800;
            font-size: 16px;
            z-index: 200;
            transform: translateY(150px);
            transition: transform 0.3s;
            border-radius: 16px;
            pointer-events: none;
        }

        #auto-adv-banner.show {
            transform: translateY(0);
        }

        .hist-item {
            padding: 8px;
            border-bottom: 1px solid #334155;
            color: #cbd5e1;
            display: flex;
            align-items: center;
        }

        .hist-chk {
            margin-right: 10px;
            width: 20px;
            height: 20px;
            border-radius: 4px;
            accent-color: #EF4444;
            display: none;
        }

        .hist-edit-mode .hist-chk {
            display: block;
        }
    </style>
</head>

<body>
    <div id="auto-adv-banner">Hole Complete! Next in 3s...</div>

    <!-- === SETUP SCREEN === -->
    <div id="v-setup" class="g-view active">
        <div class="flex-r">
            <div class="tx-xl">COD GOLF v226</div>
            <button class="g-btn g-btn-sm" style="background:#EF4444;" onclick="App.tryNewGame(this)">NEW GAME</button>
        </div>
        <!-- Roster/Seats/Settings... Same as before -->
        <div class="box">
            <div class="tx-sm">ROSTER</div>
            <div class="flex-r" style="gap:8px; margin-bottom:12px;">
                <input type="text" id="new-p-name" class="g-inp" placeholder="Name..." style="margin:0;">
                <button class="g-btn g-btn-sm" style="height:48px;" onclick="App.addRoster()">ADD</button>
            </div>
            <div id="roster-list" style="display:flex; flex-wrap:wrap;"></div>
            <button id="del-mode-btn" class="g-btn g-btn-sm" style="background:#334155; width:100%; margin-top:10px;"
                onclick="App.toggleDelMode()">ENABLE DELETE MODE</button>
            <div id="del-status"
                style="display:none; text-align:center; margin-top:5px; color:#EF4444; font-weight:bold; font-size:12px;">
                TAP NAME TO DELETE (NO UNDO)</div>
        </div>

        <div class="box">
            <div class="tx-sm">SEATS</div>
            <div class="role-row">
                <div class="role-lbl" style="color:#10B981">CART A<br>DRIVER</div><select id="sel-0" class="role-sel"
                    onchange="App.onRole()"></select>
            </div>
            <div class="role-row">
                <div class="role-lbl" style="color:#10B981">CART A<br>PASS</div><select id="sel-1" class="role-sel"
                    onchange="App.onRole()"></select>
            </div>
            <div class="role-row">
                <div class="role-lbl" style="color:#F59E0B">CART B<br>DRIVER</div><select id="sel-2" class="role-sel"
                    onchange="App.onRole()"></select>
            </div>
            <div class="role-row">
                <div class="role-lbl" style="color:#F59E0B">CART B<br>PASS</div><select id="sel-3" class="role-sel"
                    onchange="App.onRole()"></select>
            </div>
        </div>

        <div class="box">
            <div class="tx-sm">SETTINGS</div>
            <div class="flex-r" style="gap:10px;">
                <div style="flex:1;">
                    <div class="tx-sm">COURSE</div>
                    <select id="s-course" class="g-inp">
                        <option value="cc">Crow Creek</option>
                        <option value="jones">Sea Trail - Jones</option>
                        <option value="maples">Sea Trail - Maples</option>
                        <option value="byrd">Sea Trail - Byrd</option>
                        <option value="gen">Generic 72</option>
                    </select>
                </div>
                <div style="width:80px;">
                    <div class="tx-sm">SEG BET $</div>
                    <input type="number" id="s-bet" class="g-inp" value="5">
                </div>
            </div>
            <div class="flex-r" style="gap:10px; margin-top:10px;">
                <div style="flex:1;">
                    <div class="tx-sm">TEE</div>
                    <select id="s-tee" class="g-inp">
                        <option value="white">White</option>
                        <option value="gold">Gold</option>
                        <option value="combo">Combo</option>
                    </select>
                </div>
                <div style="width:80px;">
                    <div class="tx-sm">START</div>
                    <select id="s-start" class="g-inp">
                        <option value="1">#1</option>
                        <option value="10">#10</option>
                    </select>
                </div>
            </div>
        </div>

        <button class="g-btn" style="margin-bottom:20px;" onclick="App.startRound()">START ROUND</button>

        <div class="box">
            <div class="tx-sm" style="color:#F59E0B">CAREER EARNINGS</div>
            <div id="career-earnings" style="font-size:12px; margin-top:8px;"></div>
        </div>

        <div class="box">
            <div class="flex-r">
                <div class="tx-sm">HISTORY</div>
                <button id="hist-edit-btn" class="g-btn g-btn-sm" style="background:#334155; width:auto;"
                    onclick="App.handleManageClick()">MANAGE</button>
            </div>
            <div id="hist-list" style="max-height:200px; overflow-y:auto; font-size:12px;"></div>
        </div>
    </div>

    <!-- === DASHBOARD === -->
    <div id="v-dash" class="g-view">
        <div class="top-bar">
            <div class="flex-r" style="margin-bottom:8px;">
                <button class="nav-btn" onclick="App.navH(-1)">‚Üê</button>
                <div style="flex:1; text-align:center;">
                    <div id="d-h-num" class="tx-sm" style="letter-spacing:2px; color:#94A3B8; margin:0;">HOLE 1</div>
                    <div id="d-par" style="font-size:44px; font-weight:900; line-height:1; color:white;">4</div>
                    <div id="d-tee-ind"
                        style="font-size:10px; font-weight:900; color:#F59E0B; margin-top:-2px; text-transform:uppercase;">
                        WHITE TEE</div>
                </div>
                <button class="nav-btn" style="background:#10B981;" onclick="App.navH(1)">‚Üí</button>
            </div>
            <div class="flex-r">
                <div class="h-stat">
                    <div class="h-stat-lbl">YARDS</div>
                    <div id="d-dist" class="h-stat-val">-</div>
                </div>
                <div class="h-stat">
                    <div class="h-stat-lbl">HCP</div>
                    <div id="d-hcp" class="h-stat-val">-</div>
                </div>
                <div style="flex:1; padding-right:10px;">
                    <div id="d-fmt" class="h-stat-lbl" style="text-align:right; color:#F59E0B;">CARTS</div>
                    <div id="d-status" class="match-stat">ALL SQUARE</div>
                </div>
            </div>
            <button class="g-btn g-btn-sm"
                style="background:#334155; margin-top:8px; width:100%; border:1px solid #475569;"
                onclick="App.testFill()">TEST: FILL 6 HOLES</button>
        </div>
        <div id="lbl-t1"
            style="font-size:13px; font-weight:800; color:#10B981; margin:0 0 8px 4px; text-transform:uppercase;">TEAM A
        </div>
        <div id="slot-0" class="p-card">
            <div class="btn-act btn-minus" onclick="App.mod(0,-1)">-</div>
            <div class="ctr-area" onclick="App.setPar(0)">
                <div id="nm-0" class="p-name">P1</div>
                <div id="gh-0" class="p-ghost" style="opacity:0.5;">PAR 4</div>
                <div id="sc-0" class="p-score">4</div>
            </div>
            <div class="btn-act btn-plus" onclick="App.mod(0,1)">+</div>
        </div>
        <div id="slot-1" class="p-card">
            <div class="btn-act btn-minus" onclick="App.mod(1,-1)">-</div>
            <div class="ctr-area" onclick="App.setPar(1)">
                <div id="nm-1" class="p-name">P2</div>
                <div id="gh-1" class="p-ghost" style="opacity:0.5;">PAR 4</div>
                <div id="sc-1" class="p-score">4</div>
            </div>
            <div class="btn-act btn-plus" onclick="App.mod(1,1)">+</div>
        </div>
        <div id="lbl-t2"
            style="font-size:13px; font-weight:800; color:#F59E0B; margin:16px 0 8px 4px; text-transform:uppercase;">
            TEAM B</div>
        <div id="slot-2" class="p-card">
            <div class="btn-act btn-minus" onclick="App.mod(2,-1)">-</div>
            <div class="ctr-area" onclick="App.setPar(2)">
                <div id="nm-2" class="p-name">P3</div>
                <div id="gh-2" class="p-ghost" style="opacity:0.5;">PAR 4</div>
                <div id="sc-2" class="p-score">4</div>
            </div>
            <div class="btn-act btn-plus" onclick="App.mod(2,1)">+</div>
        </div>
        <div id="slot-3" class="p-card">
            <div class="btn-act btn-minus" onclick="App.mod(3,-1)">-</div>
            <div class="ctr-area" onclick="App.setPar(3)">
                <div id="nm-3" class="p-name">P4</div>
                <div id="gh-3" class="p-ghost" style="opacity:0.5;">PAR 4</div>
                <div id="sc-3" class="p-score">4</div>
            </div>
            <div class="btn-act btn-plus" onclick="App.mod(3,1)">+</div>
        </div>
        <div style="height:30px;"></div>
        <div class="flex-r" style="gap:10px;"><button class="g-btn" style="background:#334155;"
                onclick="App.nav('v-setup')">MENU</button><button class="g-btn" style="background:#334155; flex:1;"
                onclick="App.nav('v-card')">SCORECARD</button><button class="g-btn" style="background:#EF4444;"
                onclick="App.nav('v-card')">END</button></div>
    </div>

    <!-- === CARD/SUMMARY SCREENS === -->
    <div id="v-card" class="g-view">
        <div class="flex-r" style="margin-bottom:10px;">
            <div class="tx-xl">CARD</div><button class="g-btn g-btn-sm" style="width:auto;"
                onclick="App.nav('v-dash')">BACK TO GAME</button>
        </div>

        <!-- Scorecard Container -->
        <div id="card-con-body" class="card-con"></div>

        <!-- === SPACER AND RESULTS === -->
        <!-- Forced Spacer matching the gap above Gross Totals -->
        <div style="height:20px; width:100%;"></div>

        <div class="box" style="margin-top:0;">
            <div class="tx-sm" style="color:#10B981">SEGMENT RESULTS</div>
            <div id="res-txt" style="font-family:monospace; margin-top:10px; font-size:14px; line-height:1.5;"></div>
        </div>

        <div class="box" style="background:rgba(245, 158, 11, 0.1); border:1px solid rgba(245, 158, 11, 0.3);">
            <div style="font-size:11px; color:#F59E0B; font-weight:700;">‚ÑπÔ∏è IPHONE TIP</div>
            <div style="font-size:10px; color:#cbd5e1; margin-top:4px;">If tapping SEND doesn't open messages, the
                scorecard is already copied. Just open Messages and Paste.</div>
        </div>

        <button id="sms-btn" class="g-btn" style="margin-bottom:20px;" onclick="App.share()">SEND SMS SUMMARY</button>
        <button id="hist-btn" class="g-btn g-btn-sec" style="margin-bottom:12px;" onclick="App.saveToHistory()">SAVE TO
            HISTORY</button>
        <button class="g-btn" style="background:#EF4444;" onclick="App.tryNewGame(this)">START NEW ROUND</button>
    </div>

    <script>
        const CS = {
            'cc': {
                n: 'Crow Creek',
                p: [4, 4, 5, 4, 4, 3, 5, 3, 4, 4, 4, 5, 3, 4, 4, 3, 4, 5],
                y: {
                    white: [339, 382, 480, 331, 362, 165, 534, 168, 359, 358, 319, 517, 142, 417, 367, 156, 361, 519],
                    gold: [302, 308, 440, 291, 323, 132, 487, 141, 319, 302, 306, 470, 129, 351, 323, 130, 316, 458],
                    combo: [339, 308, 480, 331, 362, 132, 487, 141, 359, 358, 319, 470, 129, 351, 367, 130, 361, 458]
                },
                hcp: [17, 1, 5, 7, 9, 13, 3, 15, 11, 12, 16, 2, 18, 4, 10, 14, 6, 8],
                cmb: [0, 1, 0, 0, 0, 1, 1, 1, 0, 0, 0, 1, 1, 1, 0, 1, 0, 1]
            },
            'jones': {
                n: 'Sea Trail - Jones',
                p: [4, 3, 4, 4, 3, 4, 4, 5, 5, 4, 4, 4, 3, 4, 5, 4, 3, 5],
                y: {
                    white: [405, 178, 350, 365, 155, 375, 385, 482, 510, 328, 395, 385, 127, 320, 535, 405, 144, 490],
                    gold: [385, 160, 327, 300, 115, 330, 327, 458, 488, 305, 355, 347, 110, 298, 455, 367, 134, 455],
                    combo: []
                },
                hcp: [5, 17, 15, 11, 13, 3, 1, 7, 9, 10, 8, 6, 18, 14, 4, 2, 16, 12],
                cmb: [0, 0, 0, 1, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 1]
            },
            'maples': {
                n: 'Sea Trail - Maples',
                p: [4, 4, 3, 5, 3, 5, 4, 4, 4, 4, 3, 5, 4, 4, 5, 4, 3, 4],
                y: {
                    white: [295, 335, 150, 525, 170, 535, 375, 380, 445, 385, 140, 475, 315, 325, 540, 330, 160, 315],
                    gold: [275, 315, 120, 510, 160, 520, 365, 365, 420, 345, 105, 420, 225, 245, 485, 275, 110, 270],
                    combo: []
                },
                hcp: [15, 5, 17, 9, 13, 1, 3, 11, 7, 2, 18, 12, 14, 6, 4, 16, 10, 8],
                cmb: [0, 0, 0, 1, 0, 1, 0, 0, 1, 1, 0, 1, 0, 0, 1, 0, 0, 0]
            },
            'byrd': {
                n: 'Sea Trail - Byrd',
                p: [4, 3, 5, 4, 4, 4, 3, 4, 5, 4, 4, 3, 5, 4, 4, 3, 4, 5],
                y: {
                    white: [344, 165, 445, 384, 395, 360, 138, 367, 513, 383, 343, 154, 494, 356, 366, 160, 359, 417],
                    gold: [304, 139, 424, 326, 374, 313, 121, 327, 460, 359, 273, 116, 456, 343, 337, 125, 311, 344],
                    combo: []
                },
                hcp: [13, 15, 3, 1, 7, 11, 17, 9, 5, 4, 8, 16, 2, 6, 12, 18, 10, 14],
                cmb: [0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 1]
            },
            'gen': { n: 'Generic 72', p: [4, 4, 3, 4, 4, 5, 4, 3, 5, 4, 4, 3, 4, 4, 5, 4, 3, 5], y: { white: [], gold: [], combo: [] }, hcp: [], cmb: [] }
        };

        ['jones', 'maples', 'byrd'].forEach(k => {
            const c = CS[k];
            if (c.y.combo.length === 0 && c.y.white.length > 0) {
                for (let i = 0; i < 18; i++) {
                    const useGold = c.cmb[i] === 1;
                    c.y.combo[i] = useGold ? c.y.gold[i] : c.y.white[i];
                }
            }
        });

        const App = {
            d: { roster: ['Dan', 'Mike', 'Steve', 'John'], ps: ['', '', '', ''], chosen: { 0: '', 1: '', 2: '', 3: '' }, bet: 5, crs: 'jones', tee: 'white', start: 1, h: 1, s: {}, history: [], gameId: null },
            slotMap: {}, tmr: null, corr: false, delMode: false, histEdit: false,
            selIds: [],
            wakeLock: null,
            keepAwake: async function () {
                if ('wakeLock' in navigator) {
                    try {
                        this.wakeLock = await navigator.wakeLock.request('screen');
                        console.log("WakeLock Active");
                    } catch (e) { console.log("WakeLock Err", e); }
                }
            },

            init: function () {
                try {
                    let s = localStorage.getItem('GOLF_231');
                    if (!s) s = localStorage.getItem('GOLF_230'); // Migrate 230
                    if (s) {
                        this.d = JSON.parse(s);
                        if (!this.d.history) this.d.history = [];
                        if (!this.d.start) this.d.start = 1;
                    }
                } catch (e) { }
                this.renderRoster(); this.renderHistory(); this.refreshDrop(); this.restoreSet();
                if (Object.keys(this.d.s).length > 0 && this.d.ps[0]) this.nav('v-dash'); else this.nav('v-setup');
                if ('wakeLock' in navigator) {
                    document.addEventListener('visibilitychange', () => {
                        if (document.visibilityState === 'visible') this.keepAwake();
                    });
                    this.keepAwake();
                }
            },
            save: function () { localStorage.setItem('GOLF_231', JSON.stringify(this.d)); },

            tryNewGame: function (btn) {
                if (btn.innerText.includes("CONFIRM")) {
                    this.resetScores();
                } else {
                    const oldText = btn.innerText;
                    btn.innerText = "CONFIRM NEW ROUND?";
                    btn.style.backgroundColor = "#B91C1C";
                    setTimeout(() => {
                        btn.innerText = oldText;
                        btn.style.backgroundColor = "#EF4444";
                    }, 3000);
                }
            },

            resetScores: function () {
                this.d.s = {};
                this.d.start = parseInt(document.getElementById('s-start').value);
                this.d.h = this.d.start;
                this.d.ps = ['', '', '', ''];
                this.d.chosen = { 0: '', 1: '', 2: '', 3: '' };
                delete this.d.gameId;
                this.save();
                this.renderRoster();
                this.refreshDrop();
                this.restoreSet();
                this.nav('v-setup');
            },

            nav: function (id) {
                document.querySelectorAll('.g-view').forEach(e => e.classList.remove('active'));
                document.getElementById(id).classList.add('active');
                if (id === 'v-dash') this.uDash();
                if (id === 'v-card') this.uCard();
            },

            navH: function (d) {
                if (this.tmr) clearTimeout(this.tmr);
                document.getElementById('auto-adv-banner').classList.remove('show');

                let n;
                if (d === 1) {
                    if (this.d.start === 10) {
                        if (this.d.h === 18) n = 1;
                        else if (this.d.h === 9) n = 19; // Done
                        else n = this.d.h + 1;
                    } else {
                        n = this.d.h + 1;
                    }
                }
                else {
                    this.corr = true;
                    if (this.d.start === 10) {
                        if (this.d.h === 1) n = 18;
                        else if (this.d.h === 10) n = 10;
                        else n = this.d.h - 1;
                    } else {
                        if (this.d.h === 1) n = 1;
                        else n = this.d.h - 1;
                    }
                }

                if (n > 18) { alert("Done"); this.nav('v-card'); return; }
                this.d.h = n;
                this.save();
                this.uDash();
            },

            mod: function (idx, delta) {
                if (!this.d.s[this.d.h]) this.d.s[this.d.h] = {};
                const pid = this.slotMap[idx];
                let s = this.d.s[this.d.h][pid] || (CS[this.d.crs].p[this.d.h - 1]);
                s += delta;
                if (s < 1) s = 1;
                this.d.s[this.d.h][pid] = s;
                this.save();
                this.uDash();
                this.checkAuto();
            },
            setPar: function (idx) {
                if (!this.d.s[this.d.h]) this.d.s[this.d.h] = {};
                const pid = this.slotMap[idx];
                this.d.s[this.d.h][pid] = CS[this.d.crs].p[this.d.h - 1];
                this.save();
                this.uDash();
                this.checkAuto();
            },
            checkAuto: function () {
                const s = this.d.s[this.d.h];
                if (s && Object.keys(s).length === 4 && Object.values(s).every(v => v > 0)) {
                    document.getElementById('auto-adv-banner').classList.add('show');
                    if (this.tmr) clearTimeout(this.tmr);
                    this.tmr = setTimeout(() => { this.navH(1); }, 3000);
                }
            },

            testFill: function () {
                try {
                    const c = CS[this.d.crs] || CS['cc'];
                    if (!this.d.ps[0]) { alert("Start round first!"); return; }

                    if (Object.keys(this.slotMap).length === 0) {
                        [0, 1, 2, 3].forEach(i => this.slotMap[i] = i);
                    }

                    for (let i = 0; i < 6; i++) {
                        const par = c.p[this.d.h - 1];
                        if (!this.d.s[this.d.h]) this.d.s[this.d.h] = {};

                        [0, 1, 2, 3].forEach(p => {
                            const min = par - 1;
                            const max = par + 2;
                            const pid = (this.slotMap[p] !== undefined) ? this.slotMap[p] : p;
                            this.d.s[this.d.h][pid] = Math.floor(Math.random() * (max - min + 1)) + min;
                        });

                        let nextH;
                        if (this.d.start === 10) {
                            if (this.d.h === 18) nextH = 1;
                            else if (this.d.h === 9) nextH = 99;
                            else nextH = this.d.h + 1;
                        } else {
                            if (this.d.h === 18) nextH = 99;
                            else nextH = this.d.h + 1;
                        }

                        if (nextH === 99) {
                            this.save();
                            this.nav('v-card');
                            return;
                        }
                        this.d.h = nextH;
                    }
                    this.save();
                    this.uDash();
                } catch (e) {
                    alert("Test Error: " + e.message);
                }
            },

            toggleDelMode: function () { this.delMode = !this.delMode; const b = document.getElementById('del-mode-btn'), l = document.getElementById('roster-list'), s = document.getElementById('del-status'); if (this.delMode) { b.innerText = "DONE DELETING"; b.style.background = "#EF4444"; l.classList.add('del-mode'); s.style.display = "block"; } else { b.innerText = "ENABLE DELETE MODE"; b.style.background = "#334155"; l.classList.remove('del-mode'); s.style.display = "none"; } },
            renderRoster: function () { const c = document.getElementById('roster-list'); c.innerHTML = ''; this.d.roster.forEach(p => { const d = document.createElement('div'); d.className = 'chip'; d.innerHTML = `<div class="chip-lbl">${p}</div>`; d.setAttribute('onclick', `App.clickRoster('${p.replace(/'/g, "\\'")}')`); c.appendChild(d); }); },
            clickRoster: function (p) { if (this.delMode) this.delP(p); },
            addRoster: function () { const el = document.getElementById('new-p-name'); const v = el.value.trim(); if (v && !this.d.roster.includes(v)) { this.d.roster.push(v); el.value = ''; this.save(); this.renderRoster(); this.refreshDrop(); } },
            delP: function (p) { this.d.roster = this.d.roster.filter(n => n !== p); this.save(); this.renderRoster(); this.refreshDrop(); },
            refreshDrop: function () { [0, 1, 2, 3].forEach(i => { const el = document.getElementById('sel-' + i); const c = this.d.chosen[i]; const u = [];[0, 1, 2, 3].forEach(k => { if (k !== i && this.d.chosen[k]) u.push(this.d.chosen[k]) }); const o = this.d.roster.filter(n => !u.includes(n)); if (c && !u.includes(c) && !o.includes(c) && this.d.roster.includes(c)) o.push(c); let h = '<option value="">--</option>'; o.forEach(x => { h += `<option value="${x}" ${x === c ? 'selected' : ''}>${x}</option>` }); el.innerHTML = h; el.value = c; }); },
            onRole: function () { [0, 1, 2, 3].forEach(i => this.d.chosen[i] = document.getElementById('sel-' + i).value); this.save(); this.refreshDrop(); },
            restoreSet: function () { const ids = ['s-course', 's-tee', 's-bet', 's-start']; ids.forEach(k => document.getElementById(k).value = this.d[k.replace('s-', '')]); },
            startRound: function () { const p = [0, 1, 2, 3].map(i => this.d.chosen[i]); if (p.some(x => !x)) { alert("Seats!"); return; } this.d.ps = p; this.d.crs = document.getElementById('s-course').value; this.d.tee = document.getElementById('s-tee').value; this.d.bet = parseInt(document.getElementById('s-bet').value); this.d.start = parseInt(document.getElementById('s-start').value); this.d.s = {}; this.d.h = this.d.start; this.save(); this.nav('v-dash'); this.keepAwake(); },

            uDash: function () { const c = CS[this.d.crs], par = c.p[this.d.h - 1]; document.getElementById('d-h-num').innerText = "HOLE " + this.d.h; document.getElementById('d-par').innerText = par; const dists = c.y[this.d.tee] || []; document.getElementById('d-dist').innerText = dists[this.d.h - 1] || '-'; document.getElementById('d-hcp').innerText = (c.hcp[this.d.h - 1] || '-'); let tT = this.d.tee.toUpperCase() + " TEE"; if (this.d.tee === 'combo') { const isGold = (c.cmb && c.cmb[this.d.h - 1] === 1); if (isGold) tT = "GOLD TEE"; else tT = "WHITE TEE"; } document.getElementById('d-tee-ind').innerText = tT; document.getElementById('d-tee-ind').style.color = (tT.includes('GOLD') ? '#F59E0B' : 'white'); let ef = ((this.d.h - 1) % 18) + 1; let m = 0; if (ef > 6) m = 1; if (ef > 12) m = 2; let t1, t2, fmt; if (m === 0) { fmt = "CARTS (1-6)"; t1 = [0, 1]; t2 = [2, 3]; } else if (m === 1) { fmt = "OPPOSITES (7-12)"; t1 = [0, 2]; t2 = [1, 3]; } else { fmt = "DRIVERS (13-18)"; t1 = [0, 3]; t2 = [1, 2]; } document.getElementById('d-fmt').innerText = fmt; let t1Wins = 0, t2Wins = 0, sH = m === 0 ? 1 : (m === 1 ? 7 : 13); for (let k = sH; k < sH + 6; k++) { const s = this.d.s[k]; if (s && Object.keys(s).length === 4) { let best1 = Math.min(s[t1[0]], s[t1[1]]); let best2 = Math.min(s[t2[0]], s[t2[1]]); if (best1 < best2) t1Wins++; else if (best2 < best1) t2Wins++; } } let diff = t1Wins - t2Wins; let stat = "ALL SQUARE"; if (diff > 0) stat = `${this.d.ps[t1[0]].substring(0, 3)}/${this.d.ps[t1[1]].substring(0, 3)} <em style="color:#10B981">${diff} UP</em>`; else if (diff < 0) stat = `${this.d.ps[t2[0]].substring(0, 3)}/${this.d.ps[t2[1]].substring(0, 3)} <em style="color:#10B981">${Math.abs(diff)} UP</em>`; document.getElementById('d-status').innerHTML = stat; const map = (id, pid) => { this.slotMap[id] = pid; document.getElementById('nm-' + id).innerText = this.d.ps[pid]; document.getElementById('gh-' + id).innerText = "PAR " + par; const sc = this.d.s[this.d.h] && this.d.s[this.d.h][pid]; const ec = document.getElementById('slot-' + id); const es = document.getElementById('sc-' + id); if (sc) { ec.classList.add('has-score'); es.innerText = sc; es.style.color = sc < par ? '#10B981' : (sc > par ? '#F87171' : 'white'); } else { ec.classList.remove('has-score'); } }; map(0, t1[0]); map(1, t1[1]); document.getElementById('lbl-t1').innerText = `TEAM ${Math.abs(diff)} (${this.d.ps[t1[0]].substring(0, 3)} & ${this.d.ps[t1[1]].substring(0, 3)})`; map(2, t2[0]); map(3, t2[1]); document.getElementById('lbl-t2').innerText = `(${this.d.ps[t2[0]].substring(0, 3)} & ${this.d.ps[t2[1]].substring(0, 3)})`; },

            uCard: function () {
                const c = CS[this.d.crs] || CS['cc'];
                const cardCon = document.getElementById('card-con-body');
                if (!cardCon) return;

                const build9 = (startH, label) => {
                    let hH = `<tr><th>#</th>`;
                    for (let i = startH; i < startH + 9; i++) hH += `<th>${i}</th>`;
                    hH += '<th>TOT</th></tr>';

                    let hP = '<tr><td>PAR</td>';
                    let totP = 0;
                    for (let i = startH; i < startH + 9; i++) { hP += `<td>${c.p[i - 1]}</td>`; totP += c.p[i - 1]; }
                    hP += `<td>${totP}</td></tr>`;

                    let pRows = '';
                    [0, 1, 2, 3].forEach(pIdx => {
                        let r = `<tr><td>${this.d.ps[pIdx].substring(0, 8)}</td>`;
                        let tot = 0;
                        for (let i = startH; i < startH + 9; i++) {
                            const s = (this.d.s[i] && this.d.s[i][pIdx]);
                            const par = c.p[i - 1];
                            let valHTML = '';
                            if (s) {
                                tot += s;
                                const d = s - par;
                                let cls = '';
                                if (d === -1) cls = 'sc-bird';
                                else if (d <= -2) cls = 'sc-eagle';
                                else if (d === 1) cls = 'sc-bog';
                                else if (d >= 2) cls = 'sc-dbl';
                                valHTML = `<div class="sc-val ${cls}">${s}</div>`;
                            }
                            r += `<td>${valHTML}</td>`;
                        }
                        r += `<td>${tot}</td></tr>`;
                        pRows += r;
                    });

                    return `<div style="margin-bottom:20px;">
                        <div style="font-size:12px; font-weight:900; color:#10B981; margin-bottom:4px;">${label}</div>
                        <div class="card-table-wrap">
                            <table><thead id="tb-head-${startH}">${hH}</thead><tbody id="tb-body-${startH}">${hP}${pRows}</tbody></table>
                        </div>
                    </div>`;
                };

                cardCon.innerHTML = build9(1, 'FRONT 9') + build9(10, 'BACK 9');

                // GROSS TOTALS SECTION
                let totHTML = '<div style="margin-top:20px; padding:12px; background:#1E293B; border:1px solid #334155; border-radius:12px;"><div style="font-size:12px; font-weight:900; color:#10B981; margin-bottom:8px; text-transform:uppercase;">Gross Totals</div><div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">';
                this.d.ps.forEach((p, i) => {
                    let t = 0;
                    for (let h = 1; h <= 18; h++) if (this.d.s[h] && this.d.s[h][i]) t += this.d.s[h][i];
                    totHTML += `<div style="display:flex; justify-content:space-between; align-items:center; background:#0F172A; padding:8px 12px; border-radius:8px; border:1px solid #334155;"><span style="font-size:12px; font-weight:700; color:#94A3B8; text-transform:uppercase;">${p.substring(0, 8)}</span><span style="font-size:15px; font-weight:900; color:white;">${t || '-'}</span></div>`;
                });
                totHTML += '</div></div>';
                cardCon.innerHTML += totHTML;

                const bets = { 0: 0, 1: 0, 2: 0, 3: 0 }; const segs = [{ s: 1, e: 6, t1: [0, 1], t2: [2, 3] }, { s: 7, e: 12, t1: [0, 2], t2: [1, 3] }, { s: 13, e: 18, t1: [0, 3], t2: [1, 2] }]; let resTxt = "";
                segs.forEach((seg, idx) => { let winsA = 0, winsB = 0; for (let h = seg.s; h <= seg.e; h++) { const s = this.d.s[h]; if (s && Object.keys(s).length === 4) { let ba = Math.min(s[seg.t1[0]], s[seg.t1[1]]); let bb = Math.min(s[seg.t2[0]], s[seg.t2[1]]); if (ba < bb) winsA++; else if (bb < ba) winsB++; } } let wStr = "TIE"; if (winsA > winsB) { wStr = `${this.d.ps[seg.t1[0]]}/${this.d.ps[seg.t1[1]]}`; seg.t1.forEach(p => bets[p] += this.d.bet); seg.t2.forEach(p => bets[p] -= this.d.bet); } else if (winsB > winsA) { wStr = `${this.d.ps[seg.t2[0]]}/${this.d.ps[seg.t2[1]]}`; seg.t2.forEach(p => bets[p] += this.d.bet); seg.t1.forEach(p => bets[p] -= this.d.bet); } resTxt += `Seg ${idx + 1}: ${wStr} (${winsA}-${winsB})\n`; });
                resTxt += "\nNET TOTALS:\n";[0, 1, 2, 3].forEach(i => { resTxt += `${this.d.ps[i]}: ${bets[i] >= 0 ? '+' : ''}$${bets[i]}\n` }); document.getElementById('res-txt').innerText = resTxt;

                const btn = document.getElementById('hist-btn');
                if (btn) {
                    const exists = this.d.history.some(h => h.id === this.d.gameId);
                    if (exists || Object.keys(this.d.s).length === 0) { btn.disabled = true; btn.innerText = "HISTORY SAVED"; btn.style.background = "#334155"; }
                    else { btn.disabled = false; btn.innerText = "SAVE TO HISTORY"; btn.style.background = "#10B981"; }
                }
            },

            share: function () {
                try {
                    const c = CS[this.d.crs] || CS['cc']; const ps = this.d.ps;
                    const bets = { 0: 0, 1: 0, 2: 0, 3: 0 }; const segs = [{ n: 'CARTS', s: 1, e: 6, t1: [0, 1], t2: [2, 3] }, { n: 'OPPOSITES', s: 7, e: 12, t1: [0, 2], t2: [1, 3] }, { n: 'DRIVERS', s: 13, e: 18, t1: [0, 3], t2: [1, 2] }]; let segLines = [];
                    segs.forEach(seg => { let winsA = 0, winsB = 0; for (let h = seg.s; h <= seg.e; h++) { const s = this.d.s[h]; if (s && Object.keys(s).length === 4) { let ba = Math.min(s[seg.t1[0]], s[seg.t1[1]]); let bb = Math.min(s[seg.t2[0]], s[seg.t2[1]]); if (ba < bb) winsA++; else if (bb < ba) winsB++; } } let wStr = "TIE"; if (winsA > winsB) { wStr = `${ps[seg.t1[0]]}/${ps[seg.t1[1]]} (+$${this.d.bet})`; seg.t1.forEach(p => bets[p] += this.d.bet); seg.t2.forEach(p => bets[p] -= this.d.bet); } else if (winsB > winsA) { wStr = `${ps[seg.t2[0]]}/${ps[seg.t2[1]]} (+$${this.d.bet})`; seg.t2.forEach(p => bets[p] += this.d.bet); seg.t1.forEach(p => bets[p] -= this.d.bet); } segLines.push(`${seg.n}: ${wStr}`); });
                    let pmt = []; const lrs = [0, 1, 2, 3].map(i => ({ n: ps[i], net: bets[i] })).filter(v => v.net < 0); const wrs = [0, 1, 2, 3].map(i => ({ n: ps[i], net: bets[i] })).filter(v => v.net > 0).map(v => ({ ...v })); lrs.forEach(l => { let amt = Math.abs(l.net); wrs.forEach(w => { if (amt > 0 && w.net > 0) { let p = Math.min(amt, w.net); pmt.push(`${l.n} pays ${w.n} $${p}`); amt -= p; w.net -= p; } }); });
                    let txt = `‚õ≥ ${c.n}\n${this.d.tee.toUpperCase()} TEE\n\nüí∞ FINANCES\n`;[0, 1, 2, 3].forEach(i => txt += `${ps[i].padEnd(10)} ${bets[i] >= 0 ? '+' : ''}$${bets[i]}\n`); txt += `--------------------\n${segLines.join('\n')}\n\n${pmt.length ? 'üíµ ' + pmt.join('\nüíµ ') : 'ü§ù ALL SQUARE'}\n\n`;
                    const render9 = (startH, label) => {
                        // Header: H# (P) | AAA| BBB| CCC| DDD
                        let b = `[ ${label} ]\nH# (P) | ${ps.map(p => p.substr(0, 3).toUpperCase().padEnd(3)).join('|')}\n-------+--------------`;
                        for (let i = startH; i < startH + 9; i++) {
                            const par = c.p[i - 1];
                            const row = [];
                            [0, 1, 2, 3].forEach(pIdx => {
                                const s = this.d.s[i] && this.d.s[i][pIdx];
                                if (!s) row.push(' - '); // 3 chars centered
                                else {
                                    const d = s - par;
                                    let ic = '‚ö™';
                                    if (d <= -2) ic = 'üü°'; else if (d === -1) ic = 'üü¢'; else if (d === 1) ic = 'üî¥'; else if (d >= 2) ic = 'üíÄ';
                                    // Format: Icon + Score. Total visual width needs to be roughly 3 chars. 
                                    // Emoji is often 2 chars wide in monospace. Digit is 1. 2+1=3. Perfect.
                                    row.push(ic + s);
                                }
                            });
                            b += `\n${i.toString().padEnd(2)} (${par}) | ${row.join('|')}`;
                        }
                        return b + `\n\n`;
                    };
                    txt += render9(1, 'FRONT 9'); txt += render9(10, 'BACK 9');

                    let gTot = '\nGROSS SCORES:\n';
                    ps.forEach((p, i) => {
                        let sum = 0;
                        for (let h = 1; h <= 18; h++) if (this.d.s[h] && this.d.s[h][i]) sum += this.d.s[h][i];
                        gTot += `${p.padEnd(10)} ${sum || '-'}\n`;
                    });
                    txt += gTot;

                    txt += `\nSent via COD Golf App`;
                    const btn = document.getElementById('sms-btn');
                    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                    if (isMobile && navigator.share) { if (btn) btn.innerText = "OPENING SHARE..."; navigator.share({ title: 'COD Golf Scorecard', text: txt }).then(() => { if (btn) { btn.innerText = "‚úì SHARED!"; btn.style.backgroundColor = "#059669"; setTimeout(() => { btn.innerText = "SEND SMS SUMMARY"; btn.style.backgroundColor = ""; }, 3000); } }).catch((err) => { if (err.name !== 'AbortError') alert(err); this.doFallbackCopy(txt, btn); }); } else { this.doFallbackCopy(txt, btn); }
                } catch (e) { alert("Share Error: " + e); }
            },
            doFallbackCopy: function (text, btn) {
                const ta = document.createElement("textarea"); ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
                if (btn) { btn.innerText = "‚úì COPIED / OPENING MSG..."; btn.style.background = "#059669"; setTimeout(() => { btn.innerText = "SEND SMS SUMMARY"; btn.style.backgroundColor = ""; }, 3000); }
                setTimeout(() => { try { window.location.href = `sms:?body=${encodeURIComponent(text)}`; } catch (e) { alert("Blocked. Text Copied."); } }, 300);
            },

            saveToHistory: function () {
                if (!this.d.s || Object.keys(this.d.s).length === 0) return;
                const c = CS[this.d.crs] || CS['cc'];
                const bets = { 0: 0, 1: 0, 2: 0, 3: 0 };
                const segs = [{ t1: [0, 1], t2: [2, 3] }, { t1: [0, 2], t2: [1, 3] }, { t1: [0, 3], t2: [1, 2] }];
                segs.forEach((seg, idx) => { let sH = (idx * 6) + 1; let eH = sH + 5; let w1 = 0, w2 = 0; for (let h = sH; h <= eH; h++) { const s = this.d.s[h]; if (s && Object.keys(s).length === 4) { let b1 = Math.min(s[seg.t1[0]], s[seg.t1[1]]); let b2 = Math.min(s[seg.t2[0]], s[seg.t2[1]]); if (b1 < b2) w1++; else if (b2 < b1) w2++; } } if (w1 > w2) { seg.t1.forEach(p => bets[p] += this.d.bet); seg.t2.forEach(p => bets[p] -= this.d.bet); } else if (w2 > w1) { seg.t2.forEach(p => bets[p] += this.d.bet); seg.t1.forEach(p => bets[p] -= this.d.bet); } });
                const rec = { id: Date.now(), date: new Date().toLocaleDateString(), course: c.n, ps: this.d.ps, net: [0, 1, 2, 3].map(i => bets[i]) };
                this.d.gameId = rec.id;
                this.d.history.push(rec);
                this.save();
                this.uCard();
                this.renderHistory();
            },

            renderHistory: function () {
                const div = document.getElementById('hist-list');
                const careerDiv = document.getElementById('career-earnings');
                if (!div || !careerDiv) return;

                const stats = {};
                const labels = {}; // Store display name

                this.d.history.forEach(r => {
                    r.ps.forEach((p, i) => {
                        const k = p.trim().toUpperCase();
                        if (!stats[k]) {
                            stats[k] = 0;
                            labels[k] = p.trim();
                        }
                        stats[k] += r.net[i];

                        // If we have a stored label that is ALL CAPS, but this new one isn't, prefer the new one (e.g. switch DAN -> Dan)
                        // This helps fix the "ugly" all caps history if a user corrected it later.
                        const curLbl = labels[k];
                        const newLbl = p.trim();
                        if (curLbl === k && newLbl !== k) {
                            labels[k] = newLbl;
                        }
                    });
                });

                let cHTML = '';
                // Sort by earnings matching the case-insensitive aggregation
                Object.keys(stats).sort((a, b) => stats[b] - stats[a]).forEach(k => {
                    const v = stats[k];
                    const pName = labels[k];
                    cHTML += `<span style="display:inline-block; margin-right:12px; color:${v >= 0 ? '#10B981' : '#F87171'}"><strong>${pName}:</strong> ${v >= 0 ? '+' : ''}${v}</span>`;
                });
                if (cHTML === '') cHTML = 'No data yet.';

                careerDiv.innerHTML = 'Updating...';
                setTimeout(() => { careerDiv.innerHTML = cHTML; }, 10);

                let hH = '';
                const hist = this.d.history.slice().reverse();

                const listClass = this.histEdit ? 'hist-edit-mode' : '';
                div.className = listClass;

                hist.forEach(r => {
                    let netS = r.ps.map((p, i) => `${p}:${r.net[i] >= 0 ? '+' : ''}${r.net[i]}`).join(', ');
                    hH += `<div class="hist-item">
                        <input type="checkbox" class="hist-chk" onchange="App.onChk(${r.id}, this)">
                        <div style="flex:1">
                            <div style="font-weight:bold; color:white;">${r.date} - ${r.course}</div>
                            <div style="font-size:11px;">${netS}</div>
                        </div>
                    </div>`;
                });

                if (hH === '') hH = '<div style="padding:10px; color:#64748b; font-style:italic;">No history yet.</div>';
                div.innerHTML = hH;
            },

            onChk: function (id, el) {
                if (el.checked) {
                    if (!this.selIds.includes(id)) this.selIds.push(id);
                } else {
                    this.selIds = this.selIds.filter(x => x !== id);
                }
                const btn = document.getElementById('hist-edit-btn');
                btn.innerText = `DELETE (${this.selIds.length})`;
            },

            handleManageClick: function () {
                if (!this.histEdit) {
                    this.histEdit = true;
                    this.selIds = [];
                    const btn = document.getElementById('hist-edit-btn');
                    btn.innerText = "DELETE (0)";
                    btn.style.backgroundColor = "#EF4444";
                    this.renderHistory();
                } else {
                    this.doDelete();
                }
            },

            doDelete: function () {
                if (this.selIds.length === 0) {
                    this.exitEditMode();
                    return;
                }
                alert(`Deleting ${this.selIds.length} items...`);
                this.d.history = this.d.history.filter(h => !this.selIds.includes(h.id));
                this.save();
                this.exitEditMode();
            },

            exitEditMode: function () {
                this.histEdit = false;
                this.selIds = [];
                const btn = document.getElementById('hist-edit-btn');
                btn.innerText = "MANAGE";
                btn.style.backgroundColor = "#334155";

                this.renderHistory();
            }
        };
        window.addEventListener('load', () => App.init());
        window.App = App;
    </script>
</body>

</html>